# ============================================================
# GANDIOL DESIGN - OPTIMISATION DE PERFORMANCE
# Configuration Serveur Nginx (nginx.conf)
# ============================================================

# Ajoutez cette configuration dans le bloc 'server' ou 'http'

# ========== COMPRESSION ==========
gzip on;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss;
gzip_buffers 16 8k;
gzip_http_version 1.1;
gzip_min_length 1000;

# Brotli compression (si disponible)
brotli on;
brotli_comp_level 6;
brotli_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss;

# ========== CACHE ==========

# Cache pour CSS et JavaScript
location ~* \.(css|js)$ {
    expires 30d;
    add_header Cache-Control "public, immutable";
    add_header Vary "Accept-Encoding";
    access_log off;
}

# Cache pour les images
location ~* \.(jpg|jpeg|png|gif|webp|svg|ico)$ {
    expires 365d;
    add_header Cache-Control "public, immutable";
    add_header Vary "Accept-Encoding";
    access_log off;
}

# Cache pour les fonts
location ~* \.(woff|woff2|ttf|eot|otf)$ {
    expires 365d;
    add_header Cache-Control "public, immutable";
    access_log off;
}

# Cache pour HTML
location ~* \.(html|htm)$ {
    expires 24h;
    add_header Cache-Control "public, must-revalidate";
    add_header Vary "Accept-Encoding";
}

# Pas de cache pour les fichiers de configuration
location ~ /\.(git|htaccess|htpasswd|svn) {
    return 403;
}

# ========== SÉCURITÉ ==========

# Désactiver le server version
server_tokens off;

# Headers de sécurité
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

# ========== PERFORMANCES ==========

# Enable HTTP/2 (si TLS/SSL)
# http2_max_field_size 16k;
# http2_max_header_size 32k;

# Timeouts
client_body_timeout 10s;
client_header_timeout 10s;
client_max_body_size 10m;
keepalive_timeout 5s 5s;
send_timeout 10s;

# Buffer sizes
client_body_buffer_size 128k;
client_max_body_size 10m;
client_header_buffer_size 1k;
large_client_header_buffers 2 1k;

# ========== REDIRECTIONS ==========

# HTTPS redirect (à ajouter dans le bloc http)
server {
    listen 80;
    server_name domain.com www.domain.com;
    return 301 https://$server_name$request_uri;
}

# Redirect www
if ($host ~ ^www\.(.*)$) {
    return 301 https://$1$request_uri;
}

# ========== PHP-FPM (si PHP) ==========

# Si vous utilisez PHP avec FastCGI
location ~ \.php$ {
    try_files $uri =404;
    fastcgi_pass unix:/var/run/php-fpm.sock;
    fastcgi_index index.php;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    include fastcgi_params;
    fastcgi_cache_bypass $skip_cache;
    fastcgi_no_cache $skip_cache;
    add_header X-Cache-Status $upstream_cache_status;
}

# ========== STATIC FILES ==========

location ~ ^/assets/ {
    expires max;
    add_header Cache-Control "public, immutable";
    access_log off;
}

location ~ ^/forms/ {
    access_log off;
}
